$(function(){var c=new Date();var g=c.getDate(),a=c.getMonth(),h=c.getFullYear();var b=false;var e=function(){setTimeout(function(){$(".fc-event").popover({placement:"bottom",content:'<div class="btn-group"><button type="button" class="btn btn-xs red-mint normal">Eliminar</button><button type="button" class="btn btn-xs btn-default normal">Editar</button><button type="button" class="btn btn-xs btn-default different" style="display: none;">Ver</button></div>',html:true,container:"body"});$(".fc-event").on("show.bs.popover",function(){$(".popover:visible").popover("hide")})},200)};var f;$("#calendar-place").fullCalendar({lang:"es",header:{left:"today",center:"title",right:"prev,next,month,agendaWeek,agendaDay"},events:{url:Routing.generate("fullcalendar_loadevents",{month:moment().format("MM"),year:moment().format("YYYY"),userId:userId,full:full}),color:"blue",textColor:"white",success:function(){e()},error:function(){toastr.error("","Error recibiendo los eventos")}},eventReceive:function(l){if(!l.allDay&&l.type==vacaciones_id){var d=$(".toast-error:visible");toastr.error("","Esta afectación tiene que ser un evento para todo el día.");var k=$('.fc-content:contains("'+l.start.format("H:mm")+'")');k.each(function(){if($(this).find('.fc-title:contains("'+l.title+'")').length==1){$("#calendar-place").fullCalendar("removeEvents",l._id);$(this).parents(".fc-event").remove()}});return}else{if(!l.allDay&&new Date(l.start.format("YYYY-MM-DD HH:mm"))<new Date()){toastr.error("","Esta afectación no puede inciar antes de la hora actual.");var k=$('.fc-content:contains("'+l.start.format("H:mm")+'")');k.each(function(){if($(this).find('.fc-title:contains("'+l.title+'")').length==1){$("#calendar-place").fullCalendar("removeEvents",l._id);$(this).parents(".fc-event").remove()}});return}}var m=l.start.format("YYYY-MM-DD HH:mm");var j=$(".fc-agendaDay-button").hasClass("fc-state-active");var i=(l.end==null&&j)?moment(m).add(2,"hours").format("YYYY-MM-DD HH:mm"):(j)?l.end.format("YYYY-MM-DD HH:mm"):m;$.ajax({url:Routing.generate("fullcalendar_store"),data:{notify:l.notify,start:m,end:i,title:l.title,allDay:(l.allDay)?1:0,color:l.color,affected:l.affected,type:l.type,desc:l.desc},type:"POST",dataType:"json",success:function(n){toastr.success("","Se ha agregado la Afectación correctamente.");l.id=n.id;$("#calendar-place").fullCalendar("updateEvent",l);$('.panel-title:contains("'+l.title+'")').parents(".panel").remove();e()},error:function(){toastr.error("","Error procesando su solicitud.")}})},viewRender:function(d,i){var k=d.calendar.getDate().format("MM");var j=d.calendar.getDate().format("YYYY");e()},eventDrop:function(d,o,m){if(!d.allDay&&d.backgroundColor===vacaciones_color){var p=$(".toast-error:visible");toastr.error("","Esta afectación tiene que ser un evento para todo el día.");m(d);return}else{if(!d.allDay&&new Date(d.start.format("YYYY-MM-DD HH:mm"))<new Date()){toastr.error("","Esta afectación no puede inciar antes de la hora actual.");m(d);return}}var j=d.start.format("YYYY-MM-DD");var n=(d.end==null)?j:d.end.format("YYYY-MM-DD");var l=(($(".fc-agendaDay-button").hasClass("fc-state-active")||$(".fc-agendaWeek-button").hasClass("fc-state-active"))&&!d.allDay);var i=(!l)?j:d.start.format("YYYY-MM-DD HH:mm");var k=(!l)?n:(d.end!==null)?d.end.format("YYYY-MM-DD HH:mm"):moment(i).add(2,"hours").format("YYYY-MM-DD HH:mm");console.log("is dayView: "+l);console.log(i+" "+k);$.ajax({url:Routing.generate("fullcalendar_changedate"),data:{id:d.id,newStartData:i,newEndData:k,allDay:d.allDay},type:"POST",dataType:"json",success:function(q){toastr.success("","Se ha cambiado la fecha de la Afectación correctamente.");e()},error:function(q){m();toastr.error("","Error procesando su solicitud.")}})},eventResize:function(k,l,j){var d=(($(".fc-agendaDay-button").hasClass("fc-state-active")||$(".fc-agendaWeek-button").hasClass("fc-state-active"))&&!k.allDay);var i=(!d)?k.end.format("YYYY-MM-DD"):(k.end!==null)?k.end.format("YYYY-MM-DD HH:mm"):moment(start).add(2,"hours").format("YYYY-MM-DD HH:mm");$.ajax({url:Routing.generate("fullcalendar_resizedate"),data:{id:k.id,newDate:i},type:"POST",dataType:"json",success:function(m){toastr.success("","Se ha cambiado el rango de fecha de la Afectación correctamente.");e()},error:function(m){j();alert("Error processing your request: "+m.responseText)}})},eventMouseover:function(j,i,d){f=j},eventClick:function(k,i,d){console.log("Event: "+k.title);console.log("Event: "+k.id);var j=moment().format("YYYY-MM-DD");if(moment(j)>moment(k.start.format("YYYY-MM-DD"))&&userId===0){$(".popover:visible").popover("hide")}else{if(userId!==0){$(".popover").find(".normal").hide().end().find(".different").show()}}$(".popover").find(".btn-default").on("click",function(){$.ajax({url:Routing.generate("fullcalendar_view"),data:{id:k.id},dataType:"json",type:"POST",success:function(l){$(".popover").popover("hide");$("#afectacion_nombre").val(l.title);$("#afectacion_tipo").val(l.type).trigger("change.select2");$("#afectacion_descripcion").val(l.desc);$("#crearModal").attr("data-affected",l.affected);$("#crearModal").attr("data-event",k.id);$("#crearModal").attr("data-allDay",k.allDay);$("#crearModal").modal("show");if(userId>0){$(".ms-selectable, #afectacion_save").hide();$("#cancelar").html("Cerrar");$(".ms-selection").css({"float":"left",width:"100%"});$("#afectacion_afectados").prop("disabled",true);$(".ms-list").unbind("click");$("#afectacion_tipo").prop("disabled",true);$("#afectacion_descripcion, #afectacion_nombre, #afectacion_notificar").prop("disabled",true)}k.color="#000"},error:function(){toastr.error("","Ha ocurrido un error");$(".popover").popover("hide")}})});$(".popover").find(".red-mint").on("click",function(){var l=$(this).parents(".popover");$(".popover").popover("hide");var m=$('[aria-describedby="'+l.attr("id")+'"]');if(confirm("¿Desea eliminar la Afectación?")){$.ajax({url:Routing.generate("fullcalendar_remove"),data:{id:k.id},type:"POST",dataType:"json",success:function(n){toastr.success("","Se eliminó la Afectación correctamente.");$("#calendar-place").fullCalendar("removeEvents",k._id);m.remove()},error:function(n){toastr.error("","Error procesando su solicitud.")}})}})},editable:true,droppable:true})});